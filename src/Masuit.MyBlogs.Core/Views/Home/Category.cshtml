@using Masuit.MyBlogs.Core.Models.DTO
@using Masuit.MyBlogs.Core.Models.Entity
@using Masuit.MyBlogs.Core.Models.ViewModel
@using Masuit.Tools.Core.Net
@using Masuit.MyBlogs.Core.Common
@using Masuit.MyBlogs.Core.Infrastructure.Services.Interface
@using Masuit.MyBlogs.Core.Models.Enum
@using Masuit.Tools.Models
@using EFCoreSecondLevelCacheInterceptor
@model Masuit.MyBlogs.Core.Models.ViewModel.HomePageViewModel
@inject ICategoryService CategoryService
@{
    var all = Model.Categories.Flatten().ToList();
    var alllist = Model.Categories;
  var cat = all.FirstOrDefault(c => c.Id == ViewBag.Category.Id);
  ViewBag.Title = "分类_" + cat.Path();
  Layout = "~/Views/Shared/_Layout.cshtml";
  var level = cat.Level();
  var children2 = new List<Category>();
  var children3 = new List<Category>();
  var parentId = cat.ParentId;
  switch (level) {
    case 1:
      children2.AddRange(cat.Children.OrderBy(c => c.Id));
      break;
    case 2:
      children2.AddRange(all.Where(c => c.ParentId == parentId).OrderBy(c => c.Name));
      children3.AddRange(cat.Children.OrderBy(c => c.Name));
      break;
    case 3:
      var topid = cat.Parent.ParentId;
      children2.AddRange(all.Where(c => c.ParentId == topid).OrderBy(c => c.Name));
      children3.AddRange(all.Where(c => c.ParentId == parentId).OrderBy(c => c.Name));
      break;
  }
}
<style>
    .bg-title {
        height: 50vh;
        max-height: 400px;
        position: relative;
        background: url(/Content/images/@(new Random().Next(1, 9)).jpg) no-repeat center;
        background-size:cover;
        background-attachment: fixed;
        margin-bottom: 10px;
    }
    .header-content {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
    }
    .header-content .divider {
        width: inherit;
        height: 20px;
        margin-top: 20px;
        border-top: 3px solid rebeccapurple;
    }
</style>
<div class="list-container">
  <ol class="breadcrumb">
    <li>
      <a asp-action="Index" asp-controller="Home">首页</a>
    </li>
    <li>
      <a asp-action="Post" asp-controller="Home">文章列表</a>
    </li>
    @if (cat.ParentId > 0) {
      if (cat.Parent.ParentId > 0) {
        <li>
          <a asp-action="Category" asp-controller="Home" asp-route-id="@cat.Parent.ParentId">@cat.Parent.Parent.Name</a>
        </li>
      }

      <li>
        <a asp-action="Category" asp-controller="Home" asp-route-id="@cat.ParentId">@cat.Parent.Name</a>
      </li>
    }
    <li class="current">
      <em>@cat.Name</em>
    </li>
  </ol>
</div>
<div class="bg-title">
  <div class="header-content text-center">
    <h2 class="size48">
      @cat.Path()
      @if (CommonHelper.SystemSettings.GetOrAdd("EnableRss", "true") == "true") {
        <a asp-action="CategoryRss" asp-controller="Subscribe" asp-route-id="@cat.Id" class="btn btn-lg btn-success" target="_blank">
          <i class="icon-rss4"></i>
        </a>
      }
      @if (Context.Request.GetHideCategories().Contains(cat.Id)) {
        <a class="btn btn-default btn-lg" onclick='blockCategory("@cat.Id","@cat.Name")'>
          <i class="icon-blocked"></i>
        </a>
      } else {
        <a class="btn btn-danger btn-lg" onclick='blockCategory("@cat.Id","@cat.Name")'>
          <i class="icon-blocked"></i>
        </a>
      }
    </h2>
    <div class="divider"></div>
    <p class="size24">
      @cat.Description
    </p>
  </div>
</div>
<div class="main-container">
  <div class="recommend-card" style="margin-bottom: 12px;">
    <div class="category-horizontal-list">
      <!-- 一级分类行 -->
      <div class="category-row category-row-1">
        <span class="category-label">一级分类：</span>
        @foreach (var category in alllist) {
          if (cat.Id == category.Id || cat.ParentId == category.Id || (level == 3 && cat.Parent.ParentId == category.Id)) {
            <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="active category-item">@category.Name</a>
          } else {
            <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="category-item">@category.Name</a>
          }
        }
      </div>
      @if (children2.Count > 0) {
        <div class="category-row category-row-2">
          <span class="category-label">二级分类：</span>
          @foreach (var category in children2) {
            if (cat.Id == category.Id || cat.ParentId == category.Id) {
              <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="active category-item">@category.Name</a>
            } else {
              <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="category-item">@category.Name</a>
            }
          }
        </div>
      }
      @if (children3.Count > 0) {
        <div class="category-row category-row-3">
          <span class="category-label">三级分类：</span>
          @foreach (var category in children3) {
            if (cat.Id == category.Id) {
              <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="active category-item">@category.Name</a>
            } else {
              <a asp-action="Category" asp-controller="Home" asp-route-id="@category.Id" class="category-item">@category.Name</a>
            }
          }
        </div>
      }
    </div>
  </div>
</div>
@{
  var user = Context.Session.Get<UserInfoDto>(SessionKey.UserInfo) ?? new UserInfoDto();
  await Html.RenderPartialAsync(user.IsAdmin ? "_MainContainer_Admin" : "_MainContainer", Model);
}