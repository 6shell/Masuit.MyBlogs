@using System.Web
@using Masuit.MyBlogs.Core.Common
@using Masuit.MyBlogs.Core.Models.DTO
@using Masuit.MyBlogs.Core.Models.ViewModel
@model Masuit.MyBlogs.Core.Models.Entity.Post
@{
  ViewBag.Title = Model.Title;
  Layout = "~/Views/Shared/_Layout.cshtml";
  string hidden = string.IsNullOrEmpty(Context.Request.Cookies["ValidateKey"]) ? "" : "hidden";
  AdvertisementDto ad = ViewBag.Ads;
}
<script src="~/UEditorPlus/ueditor.config.front.js"></script>
<script charset="utf-8" src="~/UEditorPlus/ueditor.all.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
<script>
  window.defaultUser=function(){
    return {
      NickName: `@Context.Request.Cookies["NickName"]`,
      Email: `@Context.Request.Cookies["Email"]`,
      Agree:true,
      IsAdmin:true,
      voteDownCount:@Model.VoteDownCount,
      voteUpCount:@Model.VoteUpCount
    };
  }
</script>
<div class="container" id="postApp">
  <ol class="breadcrumb">
    <li>
      <a asp-action="Index" asp-controller="Home">首页</a>
    </li>
    <li>
      <a asp-action="Post" asp-controller="Home">文章列表</a>
    </li>
    @if (Model.Category.ParentId > 0) {
      if (Model.Category.Parent.ParentId > 0) {
        <li>
          <a asp-action="Category" asp-controller="Home" asp-route-id="@Model.Category.Parent.ParentId">@Model.Category.Parent.Parent.Name</a>
        </li>
      }

      <li>
        <a asp-action="Category" asp-controller="Home" asp-route-id="@Model.Category.ParentId">@Model.Category.Parent.Name</a>
      </li>
    }
    <li>
      <a asp-action="Category" asp-controller="Home" asp-route-id="@Model.CategoryId">@Model.Category.Name</a>
    </li>
    <li class="current">
      <em>@ViewBag.Title</em>
    </li>
  </ol>
  <div class="main-container">
    <!-- 头部信息 -->
    <section class="article-header">
      <div class="article-title-row">
        <h2 class="article-title">@Html.Raw(Model.Title)</h2>
        @if (!Model.Locked) {
          <a asp-action="PushMerge" asp-controller="Post" asp-route-id="@Model.Id">
            <button class="article-op-btn">我要参与编辑</button>
          </a>
        }
      </div>
      <div class="article-meta-row">
        <div>
          <span class="author">
            <a asp-action="Author" asp-controller="Home" asp-route-author="@Model.Author">@Model.Author</a>
          </span>
          <span>
            发布于
            <a asp-action="Archieve" asp-controller="Home" asp-route-dd="@Model.PostDate.Day" asp-route-mm="@Model.PostDate.Month" asp-route-mode="@nameof(Model.PostDate)" asp-route-yyyy="@Model.PostDate.Year">
              <time class="text-info">@Model.PostDate.ToString("yyyy-MM-dd HH:mm:ss")</time>
            </a>
          </span>
        </div>
        <div>
          <span class="modifier">
            <a asp-action="Author" asp-controller="Home" asp-route-author="@Model.Modifier">@Model.Modifier</a>
          </span>
          <span>
            修改于
            <a asp-action="Archieve" asp-controller="Home" asp-route-dd="@Model.ModifyDate.Day" asp-route-mm="@Model.ModifyDate.Month" asp-route-mode="@nameof(Model.ModifyDate)" asp-route-yyyy="@Model.ModifyDate.Year">
              <time class="text-success">@Model.ModifyDate.ToString("yyyy-MM-dd HH:mm")</time>
            </a>
          </span>
        </div>
        <span>评论数：@ViewBag.CommentsCount</span>
        <span>
          正在浏览：
          <span class="text-red">{{online}}人</span>
        </span>
      </div>
      <div class="article-meta-row">
        <div class="article-tags-row">
          <span style="font-weight:600;color:#1566b6;font-size:1.06rem;">
            <i class="icon-map-pin"></i>分类：
            <span class="article-tag">
              @{
                await Html.RenderPartialAsync("CategoryPath", Model.Category);
              }
            </span>
          </span>
        </div>
        @if (Model.Seminar.Any()) {
          <div class="article-tags-row">
            <span style="font-weight:600;color:#1566b6;font-size:1.06rem;">所属专题：</span>
            @{
              var seminars = Model.Seminar;
              foreach (var s in seminars) {
                <span class="article-tag">
                  <a asp-action="Index" asp-controller="Seminar" asp-route-id="@s.Id">@s.Title</a>
                </span>
              }
            }
          </div>
        }
        @{
          if (!string.IsNullOrEmpty(Model.Label)) {
            <div class="article-tags-row">
              <span style="font-weight:600;color:#1566b6;font-size:1.06rem;">标签：</span>
              @foreach (string s in Model.Label.Split([',', '，'], StringSplitOptions.RemoveEmptyEntries)) {
                <span class="article-tag">
                  <a asp-action="Tag" asp-controller="Home" asp-route-tag="@s">
                    @s
                  </a>
                </span>
              }
            </div>
          }
        }
      </div>
    </section>
    <!-- 内容区 -->
    <section class="article-content-card">
      <div class="article-content">
        @if (DateTime.Now - Model.ModifyDate > TimeSpan.FromDays(365)) {
          <div class="old-card">
            该文章已经超过1年未更新，可能无法为您提供及时准确的资讯，请根据当下实际情况，酌情参考本文内容。
          </div>
        }
        @Html.Raw(Model.Content)
      </div>
      @{
        await Html.RenderPartialAsync("/Views/Post/ProtectContent.cshtml", Model);
      }
      @if (ad != null) {
        await Html.RenderPartialAsync("_ArticleListAdvertisement", ad);
      }
      <!-- 文章内容区 点赞+点踩按钮、历史版本次数显示示例 -->
      <div class="article-footer-row">
        <div class="like-btn-group">
          <button :disabled="disableVoteUp" @@click="voteUp" class="like-btn"> 👍赞 </button>
          <span class="like-count">{{voteUpCount}}</span>
          <button :disabled="disableVoteDown" @@click="voteDown" class="dislike-btn"> 👎踩 </button>
          <span class="dislike-count">{{voteDownCount}}</span>
        </div>
        @if (Model.Rss) {
          <a asp-action="PostRss" asp-controller="Subscribe" asp-route-id="@Model.Id" target="_blank">
            <button class="subscribe-btn" type="button">
              &#128233; 订阅本文章更新
            </button>
          </a>
        }
        @if (ViewBag.HistoryCount > 0) {
          <a asp-action="History" asp-controller="Post" asp-route-id="@Model.Id" class="history-link">
            文章历史版本
            <span style="background:#eaf6ff;color:#1566b6;border-radius:6px;padding:2px 10px;font-size:.98rem;margin-left:4px;">修改 @ViewBag.HistoryCount 次</span>
          </a>
        }
      </div>
      <div class="nav-links">
        @{
          PostModelBase prev = ViewBag.Prev;
          if (prev != null) {
            <a asp-action="Details" asp-controller="Post" asp-route-id="@prev.Id" class="nav-link">上一篇：@prev.Title</a>
          }

          PostModelBase next = ViewBag.Next;
          if (next != null) {
            <a asp-action="Details" asp-controller="Post" asp-route-id="@next.Id" class="nav-link">下一篇：@next.Title</a>
          }
        }
      </div>
      @{
        var posts = (IDictionary<int, string>) ViewBag.Related;
        if (posts.Count > 1) {
          <div class="recommend-card">
            <h2 class="recommend-title" id="recommend">相关推荐</h2>
            <ul class="recommend-list">
              @foreach (var item in posts) {
                <li class="recommend-item">
                  <a asp-action="Details" asp-controller="Post" asp-route-id="@item.Key">@item.Value</a>
                </li>
              }
            </ul>
          </div>
        }
      }
      <div class="copyright-card">
        <h2 class="recommend-title" id="copyright">版权声明</h2>
        @if (Model.DisableCopy) {
          <text>🈲⚠本文为作者原创，仅用于本站访客学习、研究和交流目的，未经授权禁止转载。️⚠🈲</text>
        } else {
          <text>
            本文仅用于学习、研究和交流目的，欢迎非商业性质转载。本文链接：
            <a asp-action="Details" asp-controller="Post" asp-route-id="@Model.Id">@HttpUtility.UrlDecode(Context.Request.Scheme + "://" + Context.Request.Host + Context.Request.Path)</a>。
          </text>
          @Html.Raw(CommonHelper.SystemSettings["Disclaimer"])
        }
      </div>
    </section>
    <section class="comment-section">
      <div class="comment-form">
        <h2 class="comment-list-title" id="comment">评论区</h2>
        @Html.AntiForgeryToken()
        @if (hidden == nameof(hidden)) {
          <p>@Context.Request.Cookies["NickName"] 您好！</p>
        } else {
          <div class="comment-form-row @hidden" style="display:flex;gap:12px;flex-wrap:wrap;">
            <input name="nickname" placeholder="您的称呼" required style="flex:1 1 140px;min-width:120px;" type="text" v-model="msg.NickName">
            <div style="position:relative;flex:1 1 240px;min-width:180px;display:flex;">
              <input name="email" placeholder="您的邮箱" required style="flex:1 1 auto;min-width:120px;padding-right:110px;" type="email" v-model="msg.Email">
              <button :disabled="disableGetcode||!msg.Email" @@click="getcode(msg.Email)" class="comment-form-btn" id="getEmailCodeBtn" style="position:absolute;right:2px;top:50%;transform:translateY(-50%);min-width:96px;height:36px;padding:0 8px;font-size:.97rem;z-index:2;" type="button"> {{codeMsg}} </button>
            </div>
            <input name="emailcode" placeholder="验证码" required style="flex:1 1 110px;min-width:80px;" type="text" v-model="msg.Code">
          </div>
        }
        <!-- 第二行：评论内容框独占一行 -->
        <div class="comment-form-row" style="width:100%;margin-top:12px;">
          <div class="ueditor" id="editor"></div>
        </div>
        <!-- 第三行：协议勾选和提交按钮同一行，右侧提交按钮 -->
        <div class="comment-form-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:18px;">
          <label style="display:flex;align-items:center;font-size:.98rem;color:#1566b6;gap:6px;">
            <input name="agreement" required style="width:18px;height:18px;margin-right:4px;" type="checkbox" v-model="msg.Agree">
            我已阅读并同意
            <a asp-action="agreement" asp-controller="Misc" style="color:#1e90ff;text-decoration:underline;" target="_blank">《评论须知》</a>
          </label>
          <button @@click="submit(msg)" class="comment-form-btn">提交评论</button>
        </div>
      </div>
      <parent-messages :data="list" :is-admin="false" @@getmsgs="getcomments" @@reply-msg="replyMsg"></parent-messages>
      <n-pagination :page-count="Math.ceil(pageConfig.total / pageConfig.size)" :page-sizes="[10, 20, 30, 50]" show-size-picker v-if="pageConfig.total > 0" v-model:page="pageConfig.page" v-model:page-size="pageConfig.size"/>
      <h4 v-if="pageConfig.total == 0">还没有评论哦，赶紧来写评论吧</h4>
    </section>
  </div>
  <n-modal :mask-closable="false" :title="`回复：${reply.for?.NickName}`" @@positive-click="submit(reply)" negative-text="取消回复" positive-text="回复评论" preset="dialog" style="width:70vw;min-width:400px" v-model:show="showPopup">
    <div class="comment-item">
      <div class="comment-meta-row">
        <div>
          <span class="comment-author">{{reply.for?.NickName}}</span>
          <span class="comment-time">{{ reply.for?.CommentDate }}</span>
        </div>
      </div>
      <div class="comment-content" v-html="reply.for?.Content"></div>
    </div>
    <form class="comment-form">
      @Html.AntiForgeryToken()
      @if (hidden == nameof(hidden)) {
        <p>@Context.Request.Cookies["NickName"] 您好！</p>
      } else {
        <div class="comment-form-row @hidden" style="display:flex;gap:12px;flex-wrap:wrap;">
          <input name="nickname" placeholder="您的称呼" required style="flex:1 1 140px;min-width:120px;" type="text" v-model="reply.NickName">
          <div style="position:relative;flex:1 1 240px;min-width:180px;display:flex;">
            <input name="email" placeholder="您的邮箱" required style="flex:1 1 auto;min-width:120px;padding-right:110px;" type="email" v-model="reply.Email">
            <button :disabled="disableGetcode||!reply.Email" @@click="getcode(reply.Email)" class="comment-form-btn" id="getEmailCodeBtn" style="position:absolute;right:2px;top:50%;transform:translateY(-50%);min-width:96px;height:36px;padding:0 8px;font-size:.97rem;z-index:2;" type="button"> {{codeMsg}} </button>
          </div>
          <input name="emailcode" placeholder="验证码" required style="flex:1 1 110px;min-width:80px;" type="text" v-model="reply.Code">
        </div>
      }
      <!-- 第二行：评论内容框独占一行 -->
      <div class="comment-form-row" style="width:100%;margin-top:12px;">
        <div class="ueditor" id="editor2"></div>
      </div>
      <!-- 第三行：协议勾选和提交按钮同一行，右侧提交按钮 -->
      <div class="comment-form-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:18px;">
        <label style="display:flex;align-items:center;font-size:.98rem;color:#1566b6;gap:6px;">
          <input name="agreement" required style="width:18px;height:18px;margin-right:4px;" type="checkbox" v-model="reply.Agree">
          我已阅读并同意
          <a asp-action="agreement" asp-controller="Misc" style="color:#1e90ff;text-decoration:underline;" target="_blank">《评论须知》</a>
        </label>
      </div>
    </form>
  </n-modal>
</div>
@if (Model.DisableCopy) {
  <style>
        /* webkit, opera, IE9 （谷歌浏览器）*/
        ::selection {
            background: transparent;
        }
        /* mozilla firefox（火狐浏览器） */
        ::-moz-selection {
            background: transparent;
        }
    </style>
}
<environment names="Development">
  <link href="~/UEditorPlus/third-party/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet"/>
  <script src="/UEditorPlus/third-party/SyntaxHighlighter/shCore.js"></script>
  <link href="~/Assets/auto-toc/auto-toc.css" rel="stylesheet"/>
  <script src="/Assets/auto-toc/auto-toc.js"></script>
  <script src="/Scripts/global/article.js"></script>
</environment>
<environment names="Stage,Production">
  @await Styles.RenderAsync("/bundles/article.css")
  @await Scripts.RenderAsync("/bundles/article.js")
</environment>
<script>
    @if (Model.DisableCopy) {
      <text>
    GlobalCopyrightProtect();
        </text>
    }
</script>