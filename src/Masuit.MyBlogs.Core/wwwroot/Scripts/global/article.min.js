function submitComment(n){loading();window.post("/comment/submit",$(n).serializeObject(),function(n){loadingDone();n.Success?(window.notie.alert({type:1,text:n.Message,time:4}),setTimeout(function(){getcomments();$("[id^='LAY_layedit']").contents().find("body").html("")},100)):window.notie.alert({type:3,text:n.Message,time:4})},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})}function bindReplyBtn(){$(".msg-list article .panel-body a").on("click",function(n){n.preventDefault();loadingDone();var t=$(this).attr("href"),i=t.substring(t.indexOf("uid")+4);$("#uid").val(i);$("#OperatingSystem2").val(DeviceInfo.OS.toString());$("#Browser2").val(DeviceInfo.browserInfo.Name+" "+DeviceInfo.browserInfo.Version);layui.use("layer",function(){var n=layui.layer;n.open({type:1,zIndex:20,title:"回复评论",area:(window.screen.width>540?540:window.screen.width)+"px",content:$("#reply"),end:function(){$("#reply").css("display","none")}})});$(".layui-layer").insertBefore($(".layui-layer-shade"));window.currentEditor=layui.layedit.build("layedit2",{tool:["strong","italic","link","unlink","face"],height:100})})}function commentVoteBind(){$(".cmvote").on("click",function(){window.post("/comment/CommentVote",{id:$(this).data("id")},function(n){n&&(n.Success?(console.log($(this).children("span.count")),$(this).children("span.count").text(parseInt($(this).children("span.count").text())+1),$(this).addClass("disabled"),this.disabled=!0,window.notie.alert({type:1,text:n.Message,time:4})):window.notie.alert({type:3,text:n.Message,time:4}))})})}function bindVote(){$("#voteup").on("click",function(){window.post("/post/voteup",{id:$("#postId").val()},function(n){n&&(n.Success?($("#voteup span").text(parseInt($("#voteup span").text())+1),$(this).addClass("disabled"),this.disabled=!0,window.notie.alert({type:1,text:n.Message,time:4})):window.notie.alert({type:3,text:n.Message,time:4}))},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})});$("#votedown").on("click",function(){window.post("/post/votedown",{id:$("#postId").val()},function(n){n&&(n.Success?($("#votedown span").text(parseInt($("#votedown span").text())+1),$(this).addClass("disabled"),this.disabled=!0,window.notie.alert({type:1,text:n.Message,time:4})):window.notie.alert({type:3,text:n.Message,time:4}))},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})})}function loadParentComments(n){var r,u;if(loading(),r="",n){var t=Enumerable.From(n.rows).Where(function(n){return n.ParentId===0}).ToArray(),i=n.page,f=n.size,e=Math.ceil(n.total/f);i=i>e?e:i;i=i<1?1:i;u=n.parentTotal-(i-1)*f;for(let i=0;i<t.length;i++)r+=`<li class="msg-list media animated fadeInRight" id='${t[i].Id}'>
                        <div class="media-body">
                            <article class="panel panel-info">
                                <header class="panel-heading">${u}# ${t[i].IsMaster?`<i class="icon icon-user"></i>`:""}${t[i].NickName}${t[i].IsMaster?`(管理员)`:""} | ${t[i].CommentDate}
                                    <span class="pull-right hidden-sm hidden-xs" style="font-size: 10px;">${GetOperatingSystem(t[i].OperatingSystem)+" | "+GetBrowser(t[i].Browser)}</span>
                                </header>
                                <div class="panel-body">
                                    ${t[i].Content} 
                                    <span class="cmvote label label-info" data-id="${t[i].Id}"><i class="icon-thumbsup"></i>(<span>${t[i].VoteCount}</span>)</span>
                                    <a class="label label-info" href="?uid=${t[i].Id}"><i class="icon-comment"></i></a>
                                    ${loadComments(n.rows,Enumerable.From(n.rows).Where(n=>n.ParentId===t[i].Id).OrderBy(n=>n.CommentDate).ToArray(),u--)}
                                </div>
                            </article>
                        </div>
                    </li>`}return loadingDone(),r}function loadComments(n,t,i,r=0){var f=["info","success","primary","warning","danger"],e=1,u;return r++,u="",Enumerable.From(t).ForEach(function(t){var o=f[r%5];u+=`<article id="${t.Id}" class="panel panel-${o}">
                        <div class="panel-heading">
                            ${r}-${e++}# ${t.IsMaster?`<i class="icon icon-user"></i>`:""}${t.NickName}${t.IsMaster?`(管理员)`:""} | ${t.CommentDate}
                            <span class="pull-right hidden-sm hidden-xs" style="font-size: 10px;">${GetOperatingSystem(t.OperatingSystem)+" | "+GetBrowser(t.Browser)}</span>
                        </div>
                        <div class="panel-body">
                            ${t.Content} 
                            <span class="cmvote label label-${o}" data-id="${t.Id}"><i class="icon-thumbsup"></i>(<span>${t.VoteCount}</span>)</span>
                            <a class="label label-${o}" href="?uid=${t.Id}"><i class="icon-comment"></i></a>
                            ${loadComments(n,Enumerable.From(n).Where(n=>n.ParentId===t.Id).OrderBy(n=>n.CommentDate),i,r)}
                        </div>
                    </article>`}),u}$(function(){$("#toc").show();var n=$("#toc").tocify({selectors:".ibox-content h3,.ibox-content h4,.ibox-content h5"}).data("toc-tocify");$(".tocify>.close").on("click",function(){$(this).parent().hide()});$("article img").click(function(){window.open($(this).attr("src"))});SyntaxHighlighter.all();SyntaxHighlighter.defaults.toolbar=!1;layui.use("layedit",function(){layui.layedit.build("layedit",{tool:["strong","italic","link","unlink","face"],height:100})});$("#code-token").on("submit",function(n){n.preventDefault();window.post("/post/CheckViewToken",$(this).serializeObject(),function(n){n.Success?window.location.reload():window.notie.alert({type:3,text:n.Message,time:4})},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})});$(".getcode").on("click",function(n){n.preventDefault();layer.tips("正在发送token，请稍候...",".getcode",{tips:[1,"#3595CC"],time:3e4});$(".getcode").attr("disabled",!0);window.post("/post/getviewtoken",{__RequestVerificationToken:$("[name=__RequestVerificationToken]").val(),email:$("#email3").val()},function(n){if(n.Success){window.notie.alert({type:1,text:"验证码发送成功，请注意查收邮件，若未收到，请检查你的邮箱地址或邮件垃圾箱！",time:4});window.localStorage.setItem("email",$("#email3").val());var t=0,i=setInterval(function(){t++;$(".getcode").text("重新发送("+(120-t)+")");t>120&&(clearInterval(i),$(".getcode").attr("disabled",!1),$(".getcode").text("重新发送"))},1e3)}else window.notie.alert({type:3,text:n.Message,time:4}),$(".getcode").attr("disabled",!1)},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})});$("#getcode").on("click",function(n){n.preventDefault();layer.tips("正在发送验证码，请稍候...","#getcode",{tips:[1,"#3595CC"],time:3e4});$("#getcode").attr("disabled",!0);$.post("/validate/sendcode",{__RequestVerificationToken:$("[name=__RequestVerificationToken]").val(),email:$("#email").val()},function(n){if(n.Success){layer.tips("验证码发送成功，请注意查收邮件，若未收到，请检查你的邮箱地址或邮件垃圾箱！","#getcode",{tips:[1,"#3595CC"],time:5e3});$("#getcode").attr("disabled",!0);var t=0,i=setInterval(function(){t++;$("#getcode").text("重新发送("+(120-t)+")");t>120&&(clearInterval(i),$("#getcode").attr("disabled",!1),$("#getcode").text("重新发送"))},1e3)}else layer.tips(n.Message,"#getcode",{tips:[1,"#3595CC"],time:5e3}),$("#getcode").attr("disabled",!1)})});$("#getcode-reply").on("click",function(n){n.preventDefault();layer.tips("正在发送验证码，请稍候...","#getcode-reply",{tips:[1,"#3595CC"],time:3e4});$("#getcode-reply").attr("disabled",!0);$.post("/validate/sendcode",{__RequestVerificationToken:$("[name=__RequestVerificationToken]").val(),email:$("#email2").val()},function(n){if(n.Success){layer.tips("验证码发送成功，请注意查收邮件，若未收到，请检查你的邮箱地址或邮件垃圾箱！","#getcode-reply",{tips:[1,"#3595CC"],time:5e3});$("#getcode-reply").attr("disabled",!0);var t=0,i=setInterval(function(){t++;$("#getcode-reply").text("重新发送("+(120-t)+")");t>120&&(clearInterval(i),$("#getcode-reply").attr("disabled",!1),$("#getcode-reply").text("重新发送"))},1e3)}else layer.tips(n.Message,"#getcode-reply",{tips:[1,"#3595CC"],time:5e3}),$("#getcode-reply").attr("disabled",!1)})});bindReplyBtn();bindVote();window.getcomments();commentVoteBind();$("#OperatingSystem").val(DeviceInfo.OS.toString());$("#Browser").val(DeviceInfo.browserInfo.Name+" "+DeviceInfo.browserInfo.Version);$("#comment").on("submit",function(n){if(n.preventDefault(),layui.layedit.sync(1),$("#name").val().trim().length<=1||$("#name").val().trim().length>24){window.notie.alert({type:3,text:"昵称要求2-24个字符！",time:4});return}if(!/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test($("#email").val().trim())){window.notie.alert({type:3,text:"请输入正确的邮箱格式！",time:4});return}if($("#email").val().indexOf("163")>1||$("#email").val().indexOf("126")>1){var t=this;swal({title:"邮箱确认",text:"检测到您输入的邮箱是网易邮箱，本站的邮件服务器可能会因为您的反垃圾设置而无法将邮件正常发送到您的邮箱，建议使用您的其他邮箱，或者检查反垃圾设置后，再点击确定按钮继续！",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"确定",cancelButtonText:"换个邮箱",confirmButtonClass:"btn btn-success btn-lg",cancelButtonClass:"btn btn-danger btn-lg",buttonsStyling:!1}).then(function(n){n===!0&&submitComment(t)});return}submitComment(this)});$(".btn-cancel").click(function(){$(":input","#reply-form").not(":button,:submit,:reset,:hidden").val("").removeAttr("checked").removeAttr("checked");layer.closeAll();setTimeout(function(){$("#reply").css("display","none")},500)});$("#reply-form").on("submit",function(n){n.preventDefault();layui.layedit.sync(window.currentEditor);loading();var t=$("#reply-form").serializeObject();if(t.NickName.trim().length<=0||t.NickName.trim().length>24){window.notie.alert({type:3,text:"昵称要求2-24个字符！",time:4});loadingDone();return}if(!/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(t.Email.trim())){window.notie.alert({type:3,text:"请输入正确的邮箱格式！",time:4});loadingDone();return}window.post("/comment/submit",t,function(n){loadingDone();n.Success?(window.notie.alert({type:1,text:n.Message,time:4}),layer.closeAll(),setTimeout(function(){window.getcomments();$("[id^='LAY_layedit']").contents().find("body").html("");$("#reply").css("display","none")},500)):window.notie.alert({type:3,text:n.Message,time:4})},function(){window.notie.alert({type:3,text:"请求失败，请稍候再试！",time:4})})})});